# Main doc: https://docs.github.com/en/free-pro-team@latest/actions/learn-github-actions/introduction-to-github-actions
# Runners spec: https://docs.github.com/en/free-pro-team@latest/actions/reference/specifications-for-github-hosted-runners
# Glob expressions: https://github.com/actions/toolkit/tree/main/packages/glob

name: Macos

###############################################################################
# Schedule:
# - push on any branch whose name matches v** or master
# - any pull request
###############################################################################
on:
  push:
    branches:
      - 2021.02
      - 2021.09
      - main
  pull_request:
    branches:
      - '**'
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:
    inputs:
      platform:
        description: 'Arguments for the platform script:'
        required: true
        default: '-extent=x -parallel=p -jobs=2 -large=e -compcert=y -set-switch=y'

###############################################################################
# Platform script options shared among all jobs
###############################################################################
env:
  PLATFORM_ARGS: -extent=x -parallel=p -jobs=2 -large=e -compcert=y -set-switch=y
  COQREGTESTING: y
  HOMEBREW_NO_INSTALL_FROM_API:
  # See https://github.com/orgs/Homebrew/discussions/4612#discussioncomment-6351357

###############################################################################
# Macos
#
# CAVEATS:
# - COQREGTESTING broken, it makes the script loop, so we install opam by hand
###############################################################################
jobs:
  Macos_platform:
    name: Macos
    runs-on: macos-latest
    strategy:
      fail-fast: false

    steps:
      - name: Git checkout
        uses: actions/checkout@v3

      - name: Set PLATFORM
        if: ${{ github.event.inputs.platform != '' }}
        run: echo "PLATFORM=${{ github.event.inputs.platform }}" >> $GITHUB_ENV

      - name: Cleanup, update and upgrade HomeBrew
        # This is to avoid errors of these kinds:
        # - ==> Downloading https://ghcr.io/v2/homebrew/core/harfbuzz/manifests/5.1.0
        #   Error: adwaita-icon-theme: Failed to download resource "harfbuzz_bottle_manifest"
        #   The downloaded GitHub Packages manifest was corrupted or modified (it is not valid JSON): 
        # - dyld[45184]: Library not loaded: '/usr/local/opt/libunistring/lib/libunistring.2.dylib'
        #   Referenced from: '/usr/local/Cellar/wget/1.21.3/bin/wget'
        #   Reason: tried: '/usr/local/opt/libunistring/lib/libunistring.2.dylib' (no such file),
        run: |
          brew cleanup
          # See https://github.com/orgs/Homebrew/discussions/4612#discussioncomment-6351357
          brew untap homebrew/core homebrew/cask
          
      - name: Brew update and upgrade
        run: |
            brew update
            # Note: brew upgrade does fail regularly, but brew is anyway in a better state afterwards
            brew upgrade || true

      - name: Brew config and doctor for issues
        run: |
          brew doctor
          brew config
    
      

      - name: Test coreutils install
        run: |
          brew install coreutils